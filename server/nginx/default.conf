server {
    listen 80;
    server_name localhost;

    # Página estática opcional
    location / {
        root /usr/share/nginx/html;
        index index.html;
    }

    # Moodle em /moodle/
    location /moodle/ {
        # Pass requests to the Moodle service using the Docker service name.
        # Note: do NOT include a trailing slash on proxy_pass here so nginx
        # will append the original request URI after the upstream host.
        proxy_pass http://moodle;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Timeouts for better reliability
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Let upstream redirects use the public WWW root. If Moodle returns
        # absolute redirects they should already point to the configured
        # WWWROOT (e.g. http://localhost:8080/moodle). Removing custom
        # proxy_redirect avoids incorrect rewriting from the internal
        # container name to the public path.
    }

}
